{% extends "base.html" %}

{% block title %}Login - Bookstore{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card">
            <div class="card-header text-center">
                <h3><i class="fas fa-sign-in-alt"></i> Login</h3>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                </form>

                <hr>

                <div class="text-center">
                    <p class="mb-0">Don't have an account?</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="showSignupForm()">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </div>
            </div>
        </div>

        <!-- Signup Form (hidden by default) -->
        <div class="card mt-3 d-none" id="signupCard">
            <div class="card-header text-center">
                <h3><i class="fas fa-user-plus"></i> Sign Up</h3>
            </div>
            <div class="card-body">
                <form id="signupForm">
                    <div class="mb-3">
                        <label for="signupEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="signupEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="signupUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="signupPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" required minlength="6">
                        <div class="form-text">Password must be at least 6 characters long.</div>
                    </div>
                    <div class="mb-3">
                        <label for="adminCode" class="form-label">Admin Code (Optional)</label>
                        <input type="text" class="form-control" id="adminCode" placeholder="Enter admin code to create admin account">
                        <div class="form-text">Leave blank for regular user account. Contact administrator for admin code.</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </button>
                    </div>
                </form>

                <hr>

                <div class="text-center">
                    <p class="mb-0">Already have an account?</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show signup form
    function showSignupForm() {
        document.getElementById('loginForm').parentElement.parentElement.classList.add('d-none');
        document.getElementById('signupCard').classList.remove('d-none');
    }

    // Show login form
    function showLoginForm() {
        document.getElementById('signupCard').classList.add('d-none');
        document.getElementById('loginForm').parentElement.parentElement.classList.remove('d-none');
    }

    // Show alert message
    function showAlert(message, type = 'danger') {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Login form submission
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const formData = new FormData();
            formData.append('username', email); // OAuth2PasswordRequestForm uses 'username' field
            formData.append('password', password);

            const response = await fetch('/auth/login', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('access_token', data.access_token);
                updateNavigation();
                showAlert('Login successful! Redirecting...', 'success');

                setTimeout(() => {
                    window.location.href = '/index';
                }, 1500);
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Login failed');
            }
        } catch (error) {
            console.error('Login error:', error);
            showAlert('Login failed. Please try again.');
        }
    });

    // Signup form submission
    document.getElementById('signupForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const email = document.getElementById('signupEmail').value;
        const username = document.getElementById('signupUsername').value;
        const password = document.getElementById('signupPassword').value;
        const adminCode = document.getElementById('adminCode').value;

        try {
            const response = await fetch('/auth/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email,
                    username,
                    password,
                    admin_code: adminCode || null
                })
            });

            if (response.ok) {
                showAlert('Account created successfully! Please login.', 'success');
                showLoginForm();
                // Pre-fill email in login form
                document.getElementById('email').value = email;
            } else {
                const error = await response.json();
                showAlert(error.detail || 'Signup failed');
            }
        } catch (error) {
            console.error('Signup error:', error);
            showAlert('Signup failed. Please try again.');
        }
    });

    // Redirect if already logged in
    document.addEventListener('DOMContentLoaded', function () {
        if (isAuthenticated()) {
            window.location.href = '/index';
        }
    });
</script>
{% endblock %}
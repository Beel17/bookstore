{% extends "base.html" %}

{% block title %}My Orders - Bookstore{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-shopping-bag"></i> My Orders</h1>
            <button class="btn btn-primary" onclick="window.location.href='/index'">
                <i class="fas fa-plus"></i> Continue Shopping
            </button>
        </div>

        <!-- Orders List -->
        <div id="ordersContainer">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <!-- Orders will be loaded here -->
            <div id="ordersList">
                <!-- Orders will be populated here -->
            </div>

            <!-- No Orders Message -->
            <div id="noOrdersMessage" class="text-center d-none">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> You haven't placed any orders yet.
                    <br>
                    <a href="/index" class="btn btn-primary mt-2">Start Shopping</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
{% endblock %}

{% block extra_js %}
<script>
    // Load user orders
    async function loadOrders() {
        if (!isAuthenticated()) {
            showAlert('Please login to view your orders', 'warning');
            window.location.href = '/login';
            return;
        }

        try {
            showLoading(true);
            const response = await apiCall('/orders/');
            displayOrders(response);
        } catch (error) {
            console.error('Error loading orders:', error);
            showAlert('Failed to load orders', 'danger');
        } finally {
            showLoading(false);
        }
    }

    // Display orders
    function displayOrders(orders) {
        const ordersList = document.getElementById('ordersList');
        const noOrdersMessage = document.getElementById('noOrdersMessage');

        if (orders.length === 0) {
            ordersList.innerHTML = '';
            noOrdersMessage.classList.remove('d-none');
            return;
        }

        noOrdersMessage.classList.add('d-none');

        ordersList.innerHTML = orders.map(order => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-1">Order #${order.id}</h5>
                            <p class="card-text text-muted mb-1">
                                <i class="fas fa-calendar"></i> 
                                ${new Date(order.created_at).toLocaleDateString()}
                            </p>
                            <p class="card-text mb-1">
                                <span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span>
                                <span class="badge ${getPaymentBadgeClass(order.payment_status)}">${order.payment_status}</span>
                            </p>
                            <p class="card-text">
                                <strong>$${order.total_amount.toFixed(2)}</strong>
                                <span class="text-muted">â€¢ ${order.order_items.length} item(s)</span>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewOrderDetails(${order.id})">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${order.payment_status === 'pending' ? `
                                <button class="btn btn-success btn-sm ms-2" onclick="payOrder(${order.id})">
                                    <i class="fas fa-credit-card"></i> Pay Now
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'completed': return 'bg-success';
            case 'pending': return 'bg-warning';
            case 'cancelled': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    // Get payment badge class
    function getPaymentBadgeClass(status) {
        switch (status) {
            case 'success': return 'bg-success';
            case 'pending': return 'bg-warning';
            case 'failed': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    // View order details
    async function viewOrderDetails(orderId) {
        try {
            const order = await apiCall(`/orders/${orderId}`);
            displayOrderDetails(order);
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        } catch (error) {
            console.error('Error loading order details:', error);
            showAlert('Failed to load order details', 'danger');
        }
    }

    // Display order details in modal
    function displayOrderDetails(order) {
        const content = document.getElementById('orderDetailsContent');
        content.innerHTML = `
            <div class="mb-3">
                <h6>Order Information</h6>
                <p><strong>Order ID:</strong> ${order.id}</p>
                <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(order.status)}">${order.status}</span></p>
                <p><strong>Payment:</strong> <span class="badge ${getPaymentBadgeClass(order.payment_status)}">${order.payment_status}</span></p>
            </div>
            
            <div class="mb-3">
                <h6>Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Book</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.order_items.map(item => `
                                <tr>
                                    <td>
                                        <strong>${item.book.title}</strong><br>
                                        <small class="text-muted">by ${item.book.author}</small>
                                    </td>
                                    <td>$${item.price.toFixed(2)}</td>
                                    <td>${item.quantity}</td>
                                    <td>$${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Total:</th>
                                <th>$${order.total_amount.toFixed(2)}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;
    }

    // Pay for order
    function payOrder(orderId) {
        window.location.href = `/checkout/${orderId}`;
    }

    // Show loading spinner
    function showLoading(show) {
        const spinner = document.getElementById('loadingSpinner');
        if (show) {
            spinner.classList.remove('d-none');
        } else {
            spinner.classList.add('d-none');
        }
    }

    // Show alert message
    function showAlert(message, type = 'danger') {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', loadOrders);
</script>
{% endblock %}
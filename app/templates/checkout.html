{% extends "base.html" %}

{% block title %}Checkout - Bookstore{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-shopping-cart"></i> Order Details</h4>
            </div>
            <div class="card-body">
                <div id="orderDetails">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-credit-card"></i> Payment</h4>
            </div>
            <div class="card-body">
                <div id="paymentSection">
                    <p>Total Amount: <strong id="totalAmount">$0.00</strong></p>
                    <button class="btn btn-primary w-100" onclick="initiatePayment()" id="payButton">
                        <i class="fas fa-credit-card"></i> Pay with Paystack
                    </button>
                </div>

                <div id="paymentStatus" class="d-none">
                    <!-- Payment status will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Payment Processing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Redirecting to payment gateway...</p>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
{% endblock %}

{% block extra_js %}
<script>
    let orderId = null;
    let order = null;
    let paymentReference = null;

    // Get order ID from URL
    function getOrderIdFromUrl() {
        const path = window.location.pathname;
        const match = path.match(/\/checkout\/(\d+)/);
        return match ? parseInt(match[1]) : null;
    }

    // Load order details
    async function loadOrderDetails() {
        if (!isAuthenticated()) {
            showAlert('Please login to view order details', 'warning');
            window.location.href = '/login';
            return;
        }

        try {
            order = await apiCall(`/orders/${orderId}`);
            displayOrderDetails(order);
            document.getElementById('totalAmount').textContent = `$${order.total_amount.toFixed(2)}`;
        } catch (error) {
            console.error('Error loading order:', error);
            showAlert('Failed to load order details', 'danger');
        }
    }

    // Display order details
    function displayOrderDetails(orderData) {
        const orderDetails = document.getElementById('orderDetails');
        orderDetails.innerHTML = `
            <div class="mb-3">
                <h5>Order #${orderData.id}</h5>
                <p class="text-muted">Created: ${new Date(orderData.created_at).toLocaleDateString()}</p>
            </div>
            
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orderData.order_items.map(item => `
                            <tr>
                                <td>
                                    <strong>${item.book.title}</strong><br>
                                    <small class="text-muted">by ${item.book.author}</small>
                                </td>
                                <td>$${item.price.toFixed(2)}</td>
                                <td>${item.quantity}</td>
                                <td>$${(item.price * item.quantity).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">Total:</th>
                            <th>$${orderData.total_amount.toFixed(2)}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Payment Status:</strong> 
                <span class="badge ${getStatusBadgeClass(orderData.payment_status)}">
                    ${orderData.payment_status}
                </span>
            </div>
        `;
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'success': return 'bg-success';
            case 'pending': return 'bg-warning';
            case 'failed': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    // Initiate payment
    async function initiatePayment() {
        if (!order) {
            showAlert('Order not loaded', 'danger');
            return;
        }

        if (order.payment_status === 'success') {
            showAlert('Order already paid', 'info');
            return;
        }

        try {
            // Get user email (you might want to store this in the order or get from user profile)
            const user = await apiCall('/auth/me');

            const paymentData = {
                order_id: order.id,
                amount: order.total_amount,
                email: user.email,
                callback_url: `${window.location.origin}/orders/payment/callback`
            };

            const response = await apiCall('/orders/payment/initiate', {
                method: 'POST',
                body: JSON.stringify(paymentData)
            });

            paymentReference = response.reference;

            // Show payment modal
            new bootstrap.Modal(document.getElementById('paymentModal')).show();

            // Redirect to Paystack
            setTimeout(() => {
                window.location.href = response.authorization_url;
            }, 2000);

        } catch (error) {
            console.error('Payment initiation error:', error);
            showAlert('Failed to initiate payment', 'danger');
        }
    }

    // Verify payment (called after returning from Paystack)
    async function verifyPayment() {
        const urlParams = new URLSearchParams(window.location.search);
        const reference = urlParams.get('reference');

        if (!reference) return;

        try {
            const result = await apiCall('/orders/payment/verify', {
                method: 'POST',
                body: JSON.stringify({ reference })
            });

            if (result.status === 'success') {
                showAlert('Payment successful!', 'success');
                loadOrderDetails(); // Reload order details
            } else {
                showAlert('Payment failed', 'danger');
            }
        } catch (error) {
            console.error('Payment verification error:', error);
            showAlert('Payment verification failed', 'danger');
        }
    }

    // Show alert message
    function showAlert(message, type = 'danger') {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function () {
        orderId = getOrderIdFromUrl();
        if (!orderId) {
            showAlert('Invalid order ID', 'danger');
            return;
        }

        await loadOrderDetails();
        await verifyPayment();
    });
</script>
{% endblock %}